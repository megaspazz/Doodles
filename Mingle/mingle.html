<!DOCTYPE html>
<html>
    <head>
        <title>Mingle - Word Game</title>
    </head>
    <body>
        <h1>M _ N G L E</h1>
        <h6>version 0.0.42</h6>
        <div style="font-family: Helvetica, sans-serif;">
            <h2>Instructions</h2>
            <ul>
                <li>Try to guess the missing letters.</li>
                <li>The missing letters are the same in all words.</li>
                <li>You only get <strong>ONE</strong> guess, so guess wisely.</li>
                <li>Press the Enter key to submit your guess.</li>
                <li>Click "Next Hint" to get another clue.</li>
                <li>Refresh the page to play another puzzle.</li>
            </ul>
        </div>
        <div id="divInput">
            <div>
                <label for="txtInput" style="font-family: Helvetica, sans-serif;"><strong>FINAL</strong> GUESS</label>
                <input id="txtInput" type="text" autofocus></input>
            </div>
            <input id="btnHint" type="button" value="Next Hint"></input>
        </div>
        <div id="divHints" style="font-family: monospace; white-space: pre; margin: 12px;"></div>
        <div id="divWinBanner" style="font-family: Helvetica, sans-serif; font-size: x-large; white-space: pre-wrap;"></div>
        <div id="divResult" style="white-space: pre-wrap;"></div>

        <script src="flasher.js" type="text/javascript"></script>
        <script src="game.js" type="text/javascript"></script>
        <script src="hint.js" type="text/javascript"></script>
        <script src="log.js" type="text/javascript"></script>
        <script src="render.js" type="text/javascript"></script>
        <script src="words.js" type="text/javascript"></script>
        <script type="text/javascript">
            let game;
            let render;
            let flasher;

			const FLASH_COLOR_WRONG_LENGTH = "Tomato";
			const FLASH_DURATION_MS = 720;

            window.onload = function() {
                Log.write("start");

                game = Game.generate(g => {
                    return g.hints.length >= 3;
                });
                game.shuffleHints();
                // Coarsely sort by difficulty of hint.
                // const score = (hint) => {
                //     const before = hint.offset;
                //     const after = hint.word.length - hint.offsetEnd();
                //     return (before + 1) * (after + 1);
                // };
                // game.hints.sort((a, b) => {
                //     return score(a) - score(b);
                // });
                Log.write(game);

                const divHints = document.getElementById("divHints");
                const divWinBanner = document.getElementById("divWinBanner");
                const divResult = document.getElementById("divResult");
                render = new Render(divHints, divWinBanner, divResult);
                Log.write("render ready");

                const txtInput = document.getElementById("txtInput");
                txtInput.onkeydown = handleInput;

                flasher = new Flasher(txtInput);

                const btnHint = document.getElementById("btnHint");
                btnHint.onclick = nextHint;
                
                Log.write("events ready");

                nextHint();
                render.drawHints(game);

                Log.write(document.getElementsByTagName("html")[0].innerHTML);

                // document.onkeydown = function(e) {
                //     Log.write(e.key, e.keyCode);
                // }
            }

            function handleInput(e) {
                if (e.key === "Enter") {
                    const guess = getTruncatedSanitizedInput();
                    if (guess.length !== game.solution.length) {
                        flasher.flashOnce(FLASH_COLOR_WRONG_LENGTH, FLASH_DURATION_MS);
                    } else {
                        flasher.endFlashOnce();
                        const txtInput = document.getElementById("txtInput");
                        const divInput = document.getElementById("divInput");
                        const divResult = document.getElementById("divResult");
                        const btnHint = document.getElementById("btnHint");
                        render.drawResult(game, guess);
                        txtInput.value = guess;
                        txtInput.disabled = true;
                        btnHint.disabled = true;
                    }
                } else {
                    setTimeout(() => {
                        render.drawHints(game, getTruncatedSanitizedInput());
                    }, 0);
                    // Log.write("real before:", txtInput.value, txtInput.selectionStart, txtInput.selectionEnd);
                    // let cursorStart = txtInput.selectionStart;
                    // setTimeout(() => {
                    //     let cursorEnd = txtInput.selectionEnd;
                    //     let cursorPosition = [cursorStart, cursorEnd];
                    //     Log.write("before:", txtInput.value, cursorPosition);
                    //     let guess = sanitizeInput(txtInput.value, cursorPosition);
                    //     Log.write("after:", guess, cursorPosition);
                    //     txtInput.value = guess;
                    //     txtInput.setSelectionRange(cursorPosition[0], cursorPosition[1]);
                    // }, 0);
                }
            }

            function nextHint() {
                ++game.hintsUsed;
                if (game.hintsUsed >= game.hints.length) {
                    const btnHint = document.getElementById("btnHint");
                    btnHint.disabled = true;
                }
                render.drawHints(game, getTruncatedSanitizedInput());
                focusInput();
            }

            function focusInput() {
                const txtInput = document.getElementById("txtInput");
                txtInput.focus();
            }

            const CHAR_CODE_UPPER_A = "A".charCodeAt(0);
            const CHAR_CODE_UPPER_Z = "Z".charCodeAt(0);

            function isUpperAlpha(c) {
                let codePoint = c.codePointAt(0);
                return CHAR_CODE_UPPER_A <= codePoint && codePoint <= CHAR_CODE_UPPER_Z;
            }

            function sanitizeInput(guess, optionalPositions) {
                const positions = optionalPositions || [];

                let sb = [];
                for (const [i, c] of [...guess.toUpperCase()].entries()) {
                    if (isUpperAlpha(c)) {
                        sb.push(c);
                    } else if (optionalPositions) {
                        let iterPositions;
                        if (positions instanceof Array) {
                            iterPositions = positions.entries();
                        } else {
                            iterPositions = Object.entries(positions);
                        }
                        for (const [j, pos] of iterPositions) {
                            if (i <= pos) {
                                --positions[j];
                            }
                        }
                    }
                }
                return sb.join("");
                // return [...guess.toUpperCase()].filter(c => isUpperAlpha(c)).join("");
            }

            function getTruncatedSanitizedInput() {
                const txtInput = document.getElementById("txtInput");
                return sanitizeInput(txtInput.value).substring(0, game.solution.length);
            }
        </script>
    </body>
</html>